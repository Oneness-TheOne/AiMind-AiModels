#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
그림 분석 결과를 LLM에 보낼 해석 프롬프트 생성기
"""

def get_tree_interpretation_prompt(analysis_result):
    """
    나무 그림 분석 결과에 대한 해석 프롬프트 생성
    
    Args:
        analysis_result: process_tree_json()의 결과 (JSON 문자열 또는 딕셔너리)
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    age = data['이미지_메타정보']['연령']
    sex = data['이미지_메타정보']['성별']
    
    prompt = f"""당신은 아동 심리 및 발달 전문가입니다. {age}세 {sex}아의 나무 그림 분석 결과를 바탕으로 심리적 해석을 제공해주세요.

    ## 분석 결과 데이터:
    {json.dumps(data, ensure_ascii=False, indent=2)}

    ## 해석 요청사항:

    다음 관점에서 종합적으로 해석해주세요:

    ### 1. 전체 구성 분석
    - 나무가 화면에서 얼마나 크게·어디에 위치하는지(작게/보통/크게, 중앙/왼쪽/오른쪽 등)가 아동의 자아상, 안정감, 환경 인식에 대해 무엇을 시사하는지

    ### 2. 나무 구성요소 분석
    - 수관, 기둥, 가지, 뿌리의 존재 여부와 위치가 아동의 발달 단계와 인지 능력을 어떻게 반영하는지
    - 각 구성요소의 크기·나무 내부 포함 여부가 아동의 세부 인식 능력과 관심사를 어떻게 보여주는지

    ### 3. 부가 요소 분석
    - 나뭇잎, 열매, 꽃의 존재와 위치가 아동의 생명력, 성장에 대한 인식, 감성 발달을 어떻게 나타내는지
    - 그네, 새, 다람쥐 등 생물/물체의 존재가 아동의 상상력, 사회성, 환경 인식에 대해 무엇을 시사하는지

    ### 4. 하늘 요소 분석
    - 달, 별, 구름의 존재와 분포가 아동의 감성, 상상력, 미래 지향성을 어떻게 반영하는지
    - 하늘 요소의 위치와 분포 패턴이 아동의 공간 인식과 감성 발달 수준을 어떻게 보여주는지

    ### 5. 연령별 발달 관점
    - {age}세 아동의 일반적인 발달 단계와 비교하여 이 그림이 보여주는 발달 수준
    - 정상 발달 범위 내인지, 특별히 주목할 만한 부분이 있는지

    ### 6. 종합 해석
    - 전체 그림이 보여주는 아동의 정서 상태, 자아상, 환경 인식, 창의성
    - 긍정적인 측면과 주의가 필요한 측면 (있는 경우)

    ## 해석 필수 규칙 (매우 중요):
    - **요소 나열만 하지 마세요.** "열매가 4개 표현되었습니다", "수관이 있습니다"처럼 관찰 사실만 쓰고 끝내지 마세요.
    - **모든 요소에 대해 반드시 심리·발달적 해석을 붙이세요.** 예: "열매가 4개 표현되었으며, 이는 성취 욕구나 결실에 대한 기대, 풍요에 대한 인식을 시사할 수 있습니다."
    - 각 JSON 필드 값은 "(관찰) + (그것이 시사하는 심리·발달적 의미)" 형태로, **핵심만 1~3문장으로 간결하게** 작성하세요. RAG 참고 지표를 활용하되 장문은 피하세요.

    ## 서술 규칙 (필수):
    - 각 JSON 필드 값은 **핵심만 1~3문장으로 간결하게** 작성하세요. 장문·중복 설명은 피하세요.
    - 해석 문장에 면적 비율(0.xx), 좌표, 퍼센트(%) 등 수치는 절대 넣지 마세요. 크기는 "작게", "보통 크기", "크게", "매우 크게" 등으로만, 위치는 "화면 중앙", "왼쪽/오른쪽에 치우쳐", "상단/하단" 등으로만 표현하여, 전문 지식이 없어도 이해하기 쉽게 작성하세요.

    ## 출력 형식 (HTP 검사 해석체계 논문 구조: 인상적·구조적·표상적 해석, 정서 영역):
    다음 JSON 형식으로 응답해주세요:
    {{
        "인상적_해석": "한 문단으로 전체 그림의 인상·평가 (문항 1~3에 해당, 요소 나열이 아닌 심리·발달적 해석)",
        "구조적_해석": {{
            "위치_및_크기": "위치·크기를 수치 없이 서술하고, 자아상·안정감·환경 인식에 시사하는 바를 해석",
            "방향_및_구도": "조감도/앙시도·절단 여부 등 구도가 시사하는 바를 해석"
        }},
        "표상적_해석": {{
            "수관_기둥_뿌리": "수관·기둥·뿌리의 표현이 자아존중감·사회적 관계에 시사하는 바를 해석",
            "가지_잎_열매": "가지·잎·열매·꽃·그네 등이 정서·성장·관계 욕구에 시사하는 바를 해석",
            "지면_기타": "지면선·주변 사물 등이 안정감·불안 등에 시사하는 바를 해석"
        }},
        "정서_영역_소견": "논문 9가지 정서 영역(공격성, 사회불안, 우울, 대인회피, 자존감위축, 정서불안, 애정결핍, 열등감, 퇴행) 중 이 그림에서 관련될 수 있는 부분을 한 문단으로 요약",
        "추천_사항": {{
            "정서_심리_지원": ["정서·심리 관련 추천 문장 1", "문장 2 (선택)"],
            "대인관계_사회성": ["대인관계·사회성 관련 추천 문장 1", "문장 2 (선택)"],
            "양육_일상_활동": ["양육·일상 활동 관련 추천 문장 1", "문장 2 (선택)"]
        }}
    }}
    - 추천_사항: 논문 9가지 정서 영역을 3개 상위 영역으로 나누어, 이 그림 해석에 맞는 부모·양육자용 구체적 추천을 각 1~2문장으로 작성.
      · 정서_심리_지원: 우울, 정서불안, 애정결핍, 열등감, 퇴행, 자존감위축 관련 (감정 지지, 자기존중감, 안정감).
      · 대인관계_사회성: 공격성, 사회불안, 대인회피 관련 (타인과의 관계, 소통, 갈등).
      · 양육_일상_활동: 위 영역을 반영한 구체적 일상·양육 활동 제안 (대화, 놀이, 규칙, 가정 활동 등).

    출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요. 마크다운(##, *, **)이나 서두 설명을 넣지 말고, JSON만 출력합니다.

    중요: 객관적이고 전문적인 관점에서 해석하며, 과도한 진단이나 부정적 해석을 피하고, 발달 관점에서 건설적인 피드백을 제공해주세요. 모든 문장은 "~입니다"로 끝나는 단순 기술이 아니라 "~를 시사합니다/반영합니다" 형태의 해석을 포함하세요."""
        
    return prompt


def get_person_interpretation_prompt(analysis_result, person_type="남자사람"):
    """
    사람 그림 분석 결과에 대한 해석 프롬프트 생성
    
    Args:
        analysis_result: process_person_json()의 결과 (JSON 문자열 또는 딕셔너리)
        person_type: "남자사람" 또는 "여자사람"
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    age = data['이미지_메타정보']['연령']
    sex = data['이미지_메타정보']['성별']
    
    prompt = f"""당신은 아동 심리 및 발달 전문가입니다. {age}세 {sex}아의 {person_type} 그림 분석 결과를 바탕으로 심리적 해석을 제공해주세요.

    ## 분석 결과 데이터:
    {json.dumps(data, ensure_ascii=False, indent=2)}

    ## 해석 요청사항:

    다음 관점에서 종합적으로 해석해주세요:

    ### 1. 전체 구성 분석
    - 사람이 화면에서 얼마나 크게·어디에 위치하는지(작게/보통/크게, 중앙/왼쪽/오른쪽 등)가 아동의 자아상, 사회적 인식, 자기 표현에 대해 무엇을 시사하는지

    ### 2. 얼굴 구성요소 분석
    - 머리, 얼굴, 눈, 코, 입, 귀, 머리카락의 존재 여부와 위치가 아동의 신체 인식 발달과 자아 인식을 어떻게 보여주는지
    - 얼굴 요소의 세밀함과 크기 감각이 아동의 관찰력과 세부 인식 능력을 어떻게 나타내는지
    - 얼굴 요소의 위치와 사람 내부 포함 여부가 아동의 신체 인식 정확도를 어떻게 반영하는지

    ### 3. 신체 구성요소 분석
    - 목, 상체, 팔, 손, 다리, 발의 존재와 위치가 아동의 신체 인식 발달 단계를 어떻게 보여주는지
    - 신체 부위의 크기 감각과 배치가 아동의 신체 스키마 발달 수준을 어떻게 나타내는지
    - 좌우 대칭성 (팔, 손, 다리, 발의 개수와 위치)이 아동의 공간 인식과 신체 인식 정확도를 어떻게 반영하는지

    ### 4. 의류 및 액세서리 분석
    - 단추, 주머니, 운동화, 구두의 존재와 위치가 아동의 일상 경험, 사회적 인식, 세부 관찰력을 어떻게 보여주는지
    - 의류 요소의 세밀함이 아동의 관찰력과 표현 능력을 어떻게 나타내는지

    ### 5. 연령별 발달 관점
    - {age}세 아동의 일반적인 신체 인식 발달 단계와 비교하여 이 그림이 보여주는 발달 수준
    - 정상 발달 범위 내인지, 특별히 주목할 만한 부분이 있는지

    ### 6. 종합 해석
    - 전체 그림이 보여주는 아동의 자아 인식, 신체 인식, 사회적 인식, 표현 능력
    - 긍정적인 측면과 주의가 필요한 측면 (있는 경우)

    ## 해석 필수 규칙 (매우 중요):
    - **요소 나열만 하지 마세요.** "눈이 2개 있습니다", "팔이 그려져 있습니다"처럼 관찰 사실만 쓰고 끝내지 마세요.
    - **모든 요소에 대해 반드시 심리·발달적 해석을 붙이세요.** 예: "눈이 뚜렷하게 표현되었으며, 이는 타인에 대한 관심과 사회적 인식 발달을 시사할 수 있습니다."
    - 각 JSON 필드 값은 "(관찰) + (그것이 시사하는 심리·발달적 의미)" 형태로, **핵심만 1~3문장으로 간결하게** 작성하세요. RAG 참고 지표를 활용하되 장문은 피하세요.

    ## 서술 규칙 (필수):
    - 각 JSON 필드 값은 **핵심만 1~3문장으로 간결하게** 작성하세요. 장문·중복 설명은 피하세요.
    - 해석 문장에 면적 비율(0.xx), 좌표, 퍼센트(%) 등 수치는 절대 넣지 마세요. 크기는 "작게", "보통 크기", "크게", "매우 크게" 등으로만, 위치는 "화면 중앙", "왼쪽/오른쪽에 치우쳐", "상단/하단" 등으로만 표현하여, 전문 지식이 없어도 이해하기 쉽게 작성하세요.

    ## 출력 형식 (HTP 검사 해석체계 논문 구조: 인상적·구조적·표상적 해석, 정서 영역):
    다음 JSON 형식으로 응답해주세요:
    {{
        "인상적_해석": "한 문단으로 전체 그림의 인상·평가 (문항 1~3에 해당, 자아존중감·대인관계 관련 해석)",
        "구조적_해석": {{
            "위치_및_크기": "사람의 위치·크기를 수치 없이 서술하고, 자아상·사회적 인식에 시사하는 바를 해석",
            "방향_및_구도": "정면/측면/뒷모습·조감도 등이 시사하는 바를 해석"
        }},
        "표상적_해석": {{
            "얼굴_표상": "눈·코·입·귀·머리카락 등 얼굴 구성이 대인관계·정서에 시사하는 바를 해석",
            "신체_표상": "목·어깨·팔·손·다리·발 등 신체 표현이 자아·힘·의지에 시사하는 바를 해석",
            "의류_기타": "의류·소지품·주변 사물이 의존성·욕구 등에 시사하는 바를 해석"
        }},
        "정서_영역_소견": "논문 9가지 정서 영역(공격성, 사회불안, 우울, 대인회피, 자존감위축, 정서불안, 애정결핍, 열등감, 퇴행) 중 이 그림에서 관련될 수 있는 부분을 한 문단으로 요약",
        "추천_사항": {{
            "정서_심리_지원": ["정서·심리 관련 추천 문장 1", "문장 2 (선택)"],
            "대인관계_사회성": ["대인관계·사회성 관련 추천 문장 1", "문장 2 (선택)"],
            "양육_일상_활동": ["양육·일상 활동 관련 추천 문장 1", "문장 2 (선택)"]
        }}
    }}
    - 추천_사항: 논문 9가지 정서 영역을 3개 상위 영역으로 나누어, 이 그림 해석에 맞는 부모·양육자용 구체적 추천을 각 1~2문장으로 작성.
      · 정서_심리_지원: 우울, 정서불안, 애정결핍, 열등감, 퇴행, 자존감위축 관련 (감정 지지, 자기존중감, 안정감).
      · 대인관계_사회성: 공격성, 사회불안, 대인회피 관련 (타인과의 관계, 소통, 갈등).
      · 양육_일상_활동: 위 영역을 반영한 구체적 일상·양육 활동 제안 (대화, 놀이, 규칙, 가정 활동 등).

    출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요. 마크다운(##, *, **)이나 서두 설명을 넣지 말고, JSON만 출력합니다.

    중요: 객관적이고 전문적인 관점에서 해석하며, 과도한 진단이나 부정적 해석을 피하고, 발달 관점에서 건설적인 피드백을 제공해주세요. 모든 문장은 "~입니다"로 끝나는 단순 기술이 아니라 "~를 시사합니다/반영합니다" 형태의 해석을 포함하세요."""
    
    return prompt


def get_house_interpretation_prompt(analysis_result):
    """
    집 그림 분석 결과에 대한 해석 프롬프트 생성
    
    Args:
        analysis_result: process_house_json()의 결과 (JSON 문자열 또는 딕셔너리)
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    age = data['이미지_메타정보']['연령']
    sex = data['이미지_메타정보']['성별']
    
    prompt = f"""당신은 아동 심리 및 발달 전문가입니다. {age}세 {sex}아의 집 그림 분석 결과를 바탕으로 심리적 해석을 제공해주세요.

    ## 분석 결과 데이터:
    {json.dumps(data, ensure_ascii=False, indent=2)}

    ## 해석 요청사항:

    다음 관점에서 종합적으로 해석해주세요:

    ### 1. 전체 구성 분석
    - 집이 화면에서 얼마나 크게·어디에 위치하는지(작게/보통/크게, 중앙/왼쪽/오른쪽 등)가 아동의 가정 환경 인식, 안정감, 공간 인식에 대해 무엇을 시사하는지

    ### 2. 집 구성요소 분석
    - 지붕, 집벽, 문, 창문, 굴뚝, 연기의 존재 여부와 위치가 아동의 건축물 인식과 세부 관찰력을 어떻게 보여주는지
    - 각 구성요소의 크기·집 내부 포함 여부가 아동의 공간 인식 능력과 관심사를 어떻게 나타내는지
    - 문과 창문의 존재와 위치가 아동의 사회성, 개방성, 환경 인식에 대해 무엇을 시사하는지

    ### 3. 집 주변 요소 분석
    - 울타리, 길, 연못의 존재와 위치가 아동의 경계 인식, 이동 경로 인식, 환경 구성 능력을 어떻게 보여주는지
    - 주변 요소의 배치가 아동의 공간 구성 능력과 환경 인식을 어떻게 반영하는지

    ### 4. 하늘 및 자연 요소 분석
    - 산, 나무, 꽃, 잔디, 태양의 존재와 분포가 아동의 자연 환경 인식과 생명력에 대한 인식을 어떻게 나타내는지
    - 자연 요소의 위치와 분포 패턴이 아동의 환경 구성 능력과 감성 발달을 어떻게 보여주는지
    - 태양의 존재와 위치가 아동의 긍정적 에너지와 환경 인식을 어떻게 반영하는지

    ### 5. 연령별 발달 관점
    - {age}세 아동의 일반적인 공간 인식 발달 단계와 비교하여 이 그림이 보여주는 발달 수준
    - 정상 발달 범위 내인지, 특별히 주목할 만한 부분이 있는지

    ### 6. 종합 해석
    - 전체 그림이 보여주는 아동의 가정 환경 인식, 안정감, 공간 구성 능력, 환경 인식, 창의성
    - 긍정적인 측면과 주의가 필요한 측면 (있는 경우)

    ## 해석 필수 규칙 (매우 중요):
    - **요소 나열만 하지 마세요.** "문이 1개 있습니다", "창문이 2개 그려졌습니다"처럼 관찰 사실만 쓰고 끝내지 마세요.
    - **모든 요소에 대해 반드시 심리·발달적 해석을 붙이세요.** 예: "문이 뚜렷하게 표현되었으며, 이는 외부 세계에 대한 개방성이나 소통 욕구를 시사할 수 있습니다."
    - 각 JSON 필드 값은 "(관찰) + (그것이 시사하는 심리·발달적 의미)" 형태로, **핵심만 1~3문장으로 간결하게** 작성하세요. RAG 참고 지표를 활용하되 장문은 피하세요.

    ## 서술 규칙 (필수):
    - 각 JSON 필드 값은 **핵심만 1~3문장으로 간결하게** 작성하세요. 장문·중복 설명은 피하세요.
    - 해석 문장에 면적 비율(0.xx), 좌표, 퍼센트(%) 등 수치는 절대 넣지 마세요. 크기는 "작게", "보통 크기", "크게", "매우 크게" 등으로만, 위치는 "화면 중앙", "왼쪽/오른쪽에 치우쳐", "상단/하단" 등으로만 표현하여, 전문 지식이 없어도 이해하기 쉽게 작성하세요.

    ## 출력 형식 (HTP 검사 해석체계 논문 구조: 인상적·구조적·표상적 해석, 정서 영역):
    다음 JSON 형식으로 응답해주세요:
    {{
        "인상적_해석": "한 문단으로 전체 그림의 인상·평가 (문항 1~3에 해당, 가정 인식·안정감·정서 관련 해석)",
        "구조적_해석": {{
            "위치_및_크기": "집의 위치·크기를 수치 없이 서술하고, 가정 인식·안정감·공간 인식에 시사하는 바를 해석",
            "방향_및_구도": "조감도·투시 등 구도가 시사하는 바를 해석"
        }},
        "표상적_해석": {{
            "건축물_표상": "지붕·집벽·굴뚝·연기 등이 가정·안정감에 시사하는 바를 해석",
            "문_창문_표상": "문·창문의 존재·위치가 사회성·개방성·대인회피에 시사하는 바를 해석",
            "주변_자연_표상": "울타리·길·연못·산·나무·태양 등이 경계·환경 인식·정서에 시사하는 바를 해석"
        }},
        "정서_영역_소견": "논문 9가지 정서 영역(공격성, 사회불안, 우울, 대인회피, 자존감위축, 정서불안, 애정결핍, 열등감, 퇴행) 중 이 그림에서 관련될 수 있는 부분을 한 문단으로 요약",
        "추천_사항": {{
            "정서_심리_지원": ["정서·심리 관련 추천 문장 1", "문장 2 (선택)"],
            "대인관계_사회성": ["대인관계·사회성 관련 추천 문장 1", "문장 2 (선택)"],
            "양육_일상_활동": ["양육·일상 활동 관련 추천 문장 1", "문장 2 (선택)"]
        }}
    }}
    - 추천_사항: 논문 9가지 정서 영역을 3개 상위 영역으로 나누어, 이 그림 해석에 맞는 부모·양육자용 구체적 추천을 각 1~2문장으로 작성.
      · 정서_심리_지원: 우울, 정서불안, 애정결핍, 열등감, 퇴행, 자존감위축 관련 (감정 지지, 자기존중감, 안정감).
      · 대인관계_사회성: 공격성, 사회불안, 대인회피 관련 (타인과의 관계, 소통, 갈등).
      · 양육_일상_활동: 위 영역을 반영한 구체적 일상·양육 활동 제안 (대화, 놀이, 규칙, 가정 활동 등).

    출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요. 마크다운(##, *, **)이나 서두 설명을 넣지 말고, JSON만 출력합니다.

    중요: 객관적이고 전문적인 관점에서 해석하며, 과도한 진단이나 부정적 해석을 피하고, 발달 관점에서 건설적인 피드백을 제공해주세요. 모든 문장은 "~입니다"로 끝나는 단순 기술이 아니라 "~를 시사합니다/반영합니다" 형태의 해석을 포함하세요."""
    
    return prompt


def get_interpretation_prompt(analysis_result, rag_context=None, references=None):
    """
    분석 결과의 타입을 자동 감지하여 적절한 해석 프롬프트 반환
    
    Args:
        analysis_result: process_json()의 결과 (JSON 문자열 또는 딕셔너리)
        rag_context: ChromaDB에서 검색한 HTP 참고 지표 문자열 (RAG 사용 시)
        references: 참고 논문 파일명 목록 (RAG 사용 시, 각 항목에 출처 표기용)
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    # 타입 감지 후 기본 프롬프트 생성
    if "나무_구성요소_관계" in data:
        prompt = get_tree_interpretation_prompt(analysis_result)
    elif "얼굴_구성요소" in data:
        counts = data.get("요소_개수", {})
        if "남자구두" in counts:
            prompt = get_person_interpretation_prompt(analysis_result, "남자사람")
        elif "여자구두" in counts:
            prompt = get_person_interpretation_prompt(analysis_result, "여자사람")
        else:
            prompt = get_person_interpretation_prompt(analysis_result, "남자사람")
    elif "집_구성요소" in data:
        prompt = get_house_interpretation_prompt(analysis_result)
    else:
        raise ValueError("알 수 없는 분석 결과 타입입니다.")

    # RAG 컨텍스트가 있으면 "분석 결과 데이터" 앞에 참고 지표 섹션 삽입 (토큰 절약 + 근거 반영)
    if rag_context and rag_context.strip():
        rag_section = (
            "## 참고 지표 (HTP 논문/문헌 검색 결과)\n"
            "아래는 이 그림과 관련된 HTP 해석 지표입니다. 이 지표를 우선 참고하여 해석에 반영해주세요.\n\n"
            f"{rag_context.strip()}\n\n"
        )
        prompt = prompt.replace("## 분석 결과 데이터:", rag_section + "## 분석 결과 데이터:")

        # RAG 사용 시: 각 해석 항목에 논문_근거를 붙이도록 지시
        if references:
            ref_list = ", ".join(references)
            per_item_instruction = (
                "\n\n## RAG 사용 시 출력 규칙 (필수)\n"
                "위 JSON에서 **문자열로 표시된 모든 해석 값**은 다음 형식으로 출력하세요:\n"
                '  { "내용": "해석 내용", "논문_근거": "참고한 논문 파일명" }\n'
                "논문_근거에는 반드시 참고 지표에 나온 (출처: ...) 값 중 하나를 사용하고, "
                f"다음 목록에서만 선택하세요: {ref_list}\n"
                "예: \"인상적_해석\": { \"내용\": \"...\", \"논문_근거\": \"논문.pdf\" }, "
                "\"구조적_해석\": { \"위치_및_크기\": { \"내용\": \"...\", \"논문_근거\": \"논문.pdf\" }, ... }"
            )
            prompt = prompt.replace(
                "출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요.",
                "출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요." + per_item_instruction,
                1,
            )
    return prompt


if __name__ == "__main__":
    print("프롬프트 생성은 main.py interpret 실행 시 내부에서 사용됩니다.")
    print("  python main.py interpret 원본그림.json -o results/")
