#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
그림 분석 결과를 LLM에 보낼 해석 프롬프트 생성기
"""

def get_tree_interpretation_prompt(analysis_result):
    """
    나무 그림 분석 결과에 대한 해석 프롬프트 생성
    
    Args:
        analysis_result: process_tree_json()의 결과 (JSON 문자열 또는 딕셔너리)
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    age = data['이미지_메타정보']['연령']
    sex = data['이미지_메타정보']['성별']
    
    prompt = f"""당신은 아동 심리 및 발달 전문가입니다. {age}세 {sex}아의 나무 그림 분석 결과를 바탕으로 심리적 해석을 제공해주세요.

    ## 분석 결과 데이터:
    {json.dumps(data, ensure_ascii=False, indent=2)}

    ## 해석 요청사항:

    다음 관점에서 종합적으로 해석해주세요:

    ### 1. 전체 구성 분석
    - 나무의 위치와 크기 (면적비율, 화면 내 위치)가 아동의 자아상, 안정감, 환경 인식에 대해 무엇을 시사하는지
    - 나무의 중심 좌표와 위치 요약이 아동의 공간 인식과 자기 표현 방식에 대해 무엇을 나타내는지

    ### 2. 나무 구성요소 분석
    - 수관, 기둥, 가지, 뿌리의 존재 여부와 위치가 아동의 발달 단계와 인지 능력을 어떻게 반영하는지
    - 각 구성요소의 면적비율과 나무 내부 포함 여부가 아동의 세부 인식 능력과 관심사를 어떻게 보여주는지

    ### 3. 부가 요소 분석
    - 나뭇잎, 열매, 꽃의 존재와 위치가 아동의 생명력, 성장에 대한 인식, 감성 발달을 어떻게 나타내는지
    - 그네, 새, 다람쥐 등 생물/물체의 존재가 아동의 상상력, 사회성, 환경 인식에 대해 무엇을 시사하는지

    ### 4. 하늘 요소 분석
    - 달, 별, 구름의 존재와 분포가 아동의 감성, 상상력, 미래 지향성을 어떻게 반영하는지
    - 하늘 요소의 위치와 분포 패턴이 아동의 공간 인식과 감성 발달 수준을 어떻게 보여주는지

    ### 5. 연령별 발달 관점
    - {age}세 아동의 일반적인 발달 단계와 비교하여 이 그림이 보여주는 발달 수준
    - 정상 발달 범위 내인지, 특별히 주목할 만한 부분이 있는지

    ### 6. 종합 해석
    - 전체 그림이 보여주는 아동의 정서 상태, 자아상, 환경 인식, 창의성
    - 긍정적인 측면과 주의가 필요한 측면 (있는 경우)

    ## 출력 형식:
    다음 JSON 형식으로 응답해주세요:
    {{
        "전체_요약": "한 문단으로 전체 그림의 특징과 주요 해석",
        "구성_분석": {{
            "위치_및_크기": "나무의 위치와 크기에 대한 해석",
            "공간_인식": "공간 배치가 보여주는 인지 발달 수준"
        }},
        "구성요소_분석": {{
            "핵심_요소": "수관, 기둥, 가지, 뿌리에 대한 해석",
            "세부_인식": "각 요소의 세밀함이 보여주는 발달 수준"
        }},
        "부가요소_분석": {{
            "생명력_표현": "나뭇잎, 열매, 꽃에 대한 해석",
            "상상력_및_사회성": "생물/물체 요소에 대한 해석"
        }},
        "하늘요소_분석": {{
            "감성_발달": "하늘 요소가 보여주는 감성 수준",
            "상상력": "하늘 요소의 분포와 패턴 해석"
        }},
        "발달_평가": {{
            "연령_대비_수준": "{age}세 아동 대비 발달 수준 평가",
            "주목_사항": "특별히 주목할 만한 부분 (있는 경우)"
        }},
        "종합_해석": {{
            "정서_상태": "아동의 정서 상태에 대한 해석",
            "자아상": "자아 인식과 자기 표현에 대한 해석",
            "창의성": "창의적 표현 능력에 대한 해석",
            "긍정_측면": "긍정적으로 평가할 수 있는 부분",
            "주의_사항": "주의가 필요한 부분 (있는 경우, 없으면 null)"
        }}
    }}

    출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요. 마크다운(##, *, **)이나 서두 설명을 넣지 말고, JSON만 출력합니다.

    중요: 객관적이고 전문적인 관점에서 해석하며, 과도한 진단이나 부정적 해석을 피하고, 발달 관점에서 건설적인 피드백을 제공해주세요."""
        
    return prompt


def get_person_interpretation_prompt(analysis_result, person_type="남자사람"):
    """
    사람 그림 분석 결과에 대한 해석 프롬프트 생성
    
    Args:
        analysis_result: process_person_json()의 결과 (JSON 문자열 또는 딕셔너리)
        person_type: "남자사람" 또는 "여자사람"
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    age = data['이미지_메타정보']['연령']
    sex = data['이미지_메타정보']['성별']
    
    prompt = f"""당신은 아동 심리 및 발달 전문가입니다. {age}세 {sex}아의 {person_type} 그림 분석 결과를 바탕으로 심리적 해석을 제공해주세요.

    ## 분석 결과 데이터:
    {json.dumps(data, ensure_ascii=False, indent=2)}

    ## 해석 요청사항:

    다음 관점에서 종합적으로 해석해주세요:

    ### 1. 전체 구성 분석
    - 사람의 위치와 크기 (면적비율, 화면 내 위치)가 아동의 자아상, 사회적 인식, 자기 표현에 대해 무엇을 시사하는지
    - 사람의 중심 좌표와 위치 요약이 아동의 공간 인식과 자기 중심성 발달을 어떻게 반영하는지

    ### 2. 얼굴 구성요소 분석
    - 머리, 얼굴, 눈, 코, 입, 귀, 머리카락의 존재 여부와 위치가 아동의 신체 인식 발달과 자아 인식을 어떻게 보여주는지
    - 얼굴 요소의 세밀함과 비율이 아동의 관찰력과 세부 인식 능력을 어떻게 나타내는지
    - 얼굴 요소의 위치와 사람 내부 포함 여부가 아동의 신체 인식 정확도를 어떻게 반영하는지

    ### 3. 신체 구성요소 분석
    - 목, 상체, 팔, 손, 다리, 발의 존재와 위치가 아동의 신체 인식 발달 단계를 어떻게 보여주는지
    - 신체 부위의 비율과 배치가 아동의 신체 스키마 발달 수준을 어떻게 나타내는지
    - 좌우 대칭성 (팔, 손, 다리, 발의 개수와 위치)이 아동의 공간 인식과 신체 인식 정확도를 어떻게 반영하는지

    ### 4. 의류 및 액세서리 분석
    - 단추, 주머니, 운동화, 구두의 존재와 위치가 아동의 일상 경험, 사회적 인식, 세부 관찰력을 어떻게 보여주는지
    - 의류 요소의 세밀함이 아동의 관찰력과 표현 능력을 어떻게 나타내는지

    ### 5. 연령별 발달 관점
    - {age}세 아동의 일반적인 신체 인식 발달 단계와 비교하여 이 그림이 보여주는 발달 수준
    - 정상 발달 범위 내인지, 특별히 주목할 만한 부분이 있는지

    ### 6. 종합 해석
    - 전체 그림이 보여주는 아동의 자아 인식, 신체 인식, 사회적 인식, 표현 능력
    - 긍정적인 측면과 주의가 필요한 측면 (있는 경우)

    ## 출력 형식:
    다음 JSON 형식으로 응답해주세요:
    {{
        "전체_요약": "한 문단으로 전체 그림의 특징과 주요 해석",
        "구성_분석": {{
            "위치_및_크기": "사람의 위치와 크기에 대한 해석",
            "자아_표현": "자기 표현 방식에 대한 해석"
        }},
        "얼굴_분석": {{
            "신체_인식": "얼굴 요소가 보여주는 신체 인식 발달",
            "세부_인식": "얼굴 요소의 세밀함이 보여주는 관찰력"
        }},
        "신체_분석": {{
            "신체_스키마": "신체 부위 인식과 배치에 대한 해석",
            "대칭성": "좌우 대칭성과 공간 인식에 대한 해석",
            "발달_수준": "신체 인식 발달 단계 평가"
        }},
        "의류_분석": {{
            "일상_경험": "의류 요소가 보여주는 일상 경험과 관찰력",
            "세부_표현": "의류 요소의 세밀함에 대한 해석"
        }},
        "발달_평가": {{
            "연령_대비_수준": "{age}세 아동 대비 발달 수준 평가",
            "주목_사항": "특별히 주목할 만한 부분 (있는 경우)"
        }},
        "종합_해석": {{
            "자아_인식": "자아 인식과 자기 표현에 대한 해석",
            "신체_인식": "신체 인식 발달 수준에 대한 해석",
            "사회적_인식": "사회적 인식과 경험에 대한 해석",
            "표현_능력": "표현 능력과 관찰력에 대한 해석",
            "긍정_측면": "긍정적으로 평가할 수 있는 부분",
            "주의_사항": "주의가 필요한 부분 (있는 경우, 없으면 null)"
        }}
    }}

    출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요. 마크다운(##, *, **)이나 서두 설명을 넣지 말고, JSON만 출력합니다.

    중요: 객관적이고 전문적인 관점에서 해석하며, 과도한 진단이나 부정적 해석을 피하고, 발달 관점에서 건설적인 피드백을 제공해주세요."""
    
    return prompt


def get_house_interpretation_prompt(analysis_result):
    """
    집 그림 분석 결과에 대한 해석 프롬프트 생성
    
    Args:
        analysis_result: process_house_json()의 결과 (JSON 문자열 또는 딕셔너리)
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    age = data['이미지_메타정보']['연령']
    sex = data['이미지_메타정보']['성별']
    
    prompt = f"""당신은 아동 심리 및 발달 전문가입니다. {age}세 {sex}아의 집 그림 분석 결과를 바탕으로 심리적 해석을 제공해주세요.

    ## 분석 결과 데이터:
    {json.dumps(data, ensure_ascii=False, indent=2)}

    ## 해석 요청사항:

    다음 관점에서 종합적으로 해석해주세요:

    ### 1. 전체 구성 분석
    - 집의 위치와 크기 (면적비율, 화면 내 위치)가 아동의 가정 환경 인식, 안정감, 공간 인식에 대해 무엇을 시사하는지
    - 집의 중심 좌표와 위치 요약이 아동의 환경 인식과 자기 중심성 발달을 어떻게 반영하는지

    ### 2. 집 구성요소 분석
    - 지붕, 집벽, 문, 창문, 굴뚝, 연기의 존재 여부와 위치가 아동의 건축물 인식과 세부 관찰력을 어떻게 보여주는지
    - 각 구성요소의 면적비율과 집 내부 포함 여부가 아동의 공간 인식 능력과 관심사를 어떻게 나타내는지
    - 문과 창문의 존재와 위치가 아동의 사회성, 개방성, 환경 인식에 대해 무엇을 시사하는지

    ### 3. 집 주변 요소 분석
    - 울타리, 길, 연못의 존재와 위치가 아동의 경계 인식, 이동 경로 인식, 환경 구성 능력을 어떻게 보여주는지
    - 주변 요소의 배치가 아동의 공간 구성 능력과 환경 인식을 어떻게 반영하는지

    ### 4. 하늘 및 자연 요소 분석
    - 산, 나무, 꽃, 잔디, 태양의 존재와 분포가 아동의 자연 환경 인식과 생명력에 대한 인식을 어떻게 나타내는지
    - 자연 요소의 위치와 분포 패턴이 아동의 환경 구성 능력과 감성 발달을 어떻게 보여주는지
    - 태양의 존재와 위치가 아동의 긍정적 에너지와 환경 인식을 어떻게 반영하는지

    ### 5. 연령별 발달 관점
    - {age}세 아동의 일반적인 공간 인식 발달 단계와 비교하여 이 그림이 보여주는 발달 수준
    - 정상 발달 범위 내인지, 특별히 주목할 만한 부분이 있는지

    ### 6. 종합 해석
    - 전체 그림이 보여주는 아동의 가정 환경 인식, 안정감, 공간 구성 능력, 환경 인식, 창의성
    - 긍정적인 측면과 주의가 필요한 측면 (있는 경우)

    ## 출력 형식:
    다음 JSON 형식으로 응답해주세요:
    {{
        "전체_요약": "한 문단으로 전체 그림의 특징과 주요 해석",
        "구성_분석": {{
            "위치_및_크기": "집의 위치와 크기에 대한 해석",
            "환경_인식": "환경 인식과 공간 구성에 대한 해석"
        }},
        "집_구성요소_분석": {{
            "건축물_인식": "집 구성요소가 보여주는 건축물 인식 발달",
            "세부_관찰력": "구성요소의 세밀함이 보여주는 관찰력",
            "사회성_표현": "문과 창문이 보여주는 사회성과 개방성"
        }},
        "주변요소_분석": {{
            "경계_인식": "울타리, 길 등이 보여주는 경계와 경로 인식",
            "환경_구성": "주변 요소 배치가 보여주는 환경 구성 능력"
        }},
        "자연요소_분석": {{
            "자연_인식": "자연 요소가 보여주는 환경 인식",
            "생명력": "자연 요소의 분포가 보여주는 생명력 인식",
            "감성_발달": "자연 요소 배치가 보여주는 감성 발달"
        }},
        "발달_평가": {{
            "연령_대비_수준": "{age}세 아동 대비 발달 수준 평가",
            "주목_사항": "특별히 주목할 만한 부분 (있는 경우)"
        }},
        "종합_해석": {{
            "가정_인식": "가정 환경에 대한 인식과 안정감",
            "공간_인식": "공간 구성 능력과 환경 인식",
            "창의성": "창의적 표현 능력에 대한 해석",
            "긍정_측면": "긍정적으로 평가할 수 있는 부분",
            "주의_사항": "주의가 필요한 부분 (있는 경우, 없으면 null)"
        }}
    }}

    출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요. 마크다운(##, *, **)이나 서두 설명을 넣지 말고, JSON만 출력합니다.

    중요: 객관적이고 전문적인 관점에서 해석하며, 과도한 진단이나 부정적 해석을 피하고, 발달 관점에서 건설적인 피드백을 제공해주세요."""
    
    return prompt


def get_interpretation_prompt(analysis_result, rag_context=None, references=None):
    """
    분석 결과의 타입을 자동 감지하여 적절한 해석 프롬프트 반환
    
    Args:
        analysis_result: process_json()의 결과 (JSON 문자열 또는 딕셔너리)
        rag_context: ChromaDB에서 검색한 HTP 참고 지표 문자열 (RAG 사용 시)
        references: 참고 논문 파일명 목록 (RAG 사용 시, 각 항목에 출처 표기용)
    
    Returns:
        LLM에 보낼 프롬프트 문자열
    """
    import json
    
    if isinstance(analysis_result, str):
        data = json.loads(analysis_result)
    else:
        data = analysis_result
    
    # 타입 감지 후 기본 프롬프트 생성
    if "나무_구성요소_관계" in data:
        prompt = get_tree_interpretation_prompt(analysis_result)
    elif "얼굴_구성요소" in data:
        counts = data.get("요소_개수", {})
        if "남자구두" in counts:
            prompt = get_person_interpretation_prompt(analysis_result, "남자사람")
        elif "여자구두" in counts:
            prompt = get_person_interpretation_prompt(analysis_result, "여자사람")
        else:
            prompt = get_person_interpretation_prompt(analysis_result, "남자사람")
    elif "집_구성요소" in data:
        prompt = get_house_interpretation_prompt(analysis_result)
    else:
        raise ValueError("알 수 없는 분석 결과 타입입니다.")

    # RAG 컨텍스트가 있으면 "분석 결과 데이터" 앞에 참고 지표 섹션 삽입 (토큰 절약 + 근거 반영)
    if rag_context and rag_context.strip():
        rag_section = (
            "## 참고 지표 (HTP 논문/문헌 검색 결과)\n"
            "아래는 이 그림과 관련된 HTP 해석 지표입니다. 이 지표를 우선 참고하여 해석에 반영해주세요.\n\n"
            f"{rag_context.strip()}\n\n"
        )
        prompt = prompt.replace("## 분석 결과 데이터:", rag_section + "## 분석 결과 데이터:")

        # RAG 사용 시: 각 해석 항목에 논문_근거를 붙이도록 지시
        if references:
            ref_list = ", ".join(references)
            per_item_instruction = (
                "\n\n## RAG 사용 시 출력 규칙 (필수)\n"
                "위 JSON에서 **문자열로 표시된 모든 해석 값**은 다음 형식으로 출력하세요:\n"
                '  { "내용": "해석 내용", "논문_근거": "참고한 논문 파일명" }\n'
                "논문_근거에는 반드시 참고 지표에 나온 (출처: ...) 값 중 하나를 사용하고, "
                f"다음 목록에서만 선택하세요: {ref_list}\n"
                "예: \"전체_요약\": { \"내용\": \"...\", \"논문_근거\": \"논문.pdf\" }, "
                "\"구성_분석\": { \"위치_및_크기\": { \"내용\": \"...\", \"논문_근거\": \"논문.pdf\" }, ... }"
            )
            prompt = prompt.replace(
                "출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요.",
                "출력 규칙: 응답은 반드시 위 구조의 JSON 객체 하나만 출력하세요." + per_item_instruction,
                1,
            )
    return prompt


if __name__ == "__main__":
    print("프롬프트 생성은 main.py interpret 실행 시 내부에서 사용됩니다.")
    print("  python main.py interpret 원본그림.json -o results/")
